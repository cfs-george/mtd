<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MTD Prototype</title>
  <link rel="icon" type="image/x-icon" href="images/cfs_logo_dark_short.svg">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");

    * {
      font-family: "Inter", sans-serif;
      box-sizing: border-box;
    }

    body {
      margin: 40px auto;
      max-width: 800px;
      background-color: #f5f7fa;
      color: #222;
      transition: background-color 0.3s, color 0.3s;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }

    button {
      background: #6CA5AC;
      border: none;
      color: white;
      margin-top: 16px;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #91e5f0;
    }
    .section {
      margin-top: 20px;
      background: white;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      transition: background-color 0.3s;
    }
    .dark-mode .section {
      background: #1e1e1e;
    }
    input,
    select {
      padding: 6px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
      background: #fff;
      color: #000;
    }
    .dark-mode input,
    .dark-mode select {
      background: #2a2a2a;
      color: #fff;
      border-color: #444;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .dark-mode th,
    .dark-mode td {
      border-color: #444;
    }
    .summary {
      font-weight: bold;
      margin-top: 10px;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid #ccc;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
      background: #e9ecef;
      margin-right: 5px;
      transition: background 0.2s;
    }
    .tab:hover {
      background: #d7dde3;
    }
    .tab.active {
      background: white;
      border-bottom: 2px solid white;
      font-weight: bold;
    }
    .dark-mode .tab {
      background: #2a2a2a;
      color: #ddd;
      border-color: #444;
    }
    .dark-mode .tab.active {
      background: #1e1e1e;
      border-bottom: 2px solid #1e1e1e;
      color: #fff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .dark-mode-toggle {
      background: none;
      border: none;
      font-size: 1.4rem;
      cursor: pointer;
      color: inherit;
    }

    /* VAT & EU checkbox alignment */
    label.checkbox-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .checkbox-label input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      margin-left: 10px;
    }

    .upload {
      margin-top: 40px;
    }

    .csv-instructions {
      font-size: 0.9rem;
      color: #555;
      background: #f0f4f8;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .dark-mode .csv-instructions {
      background: #2a2a2a;
      color: #ddd;
      border-color: #444;
    }

    /* Mobile styles */
    @media (max-width: 770px) {
      body {
        margin: 20px;
      }
      .tabs {
        flex-direction: column;
      }
      .tab {
        margin-bottom: 5px;
      }
      input,
      select,
      button {
        font-size: 0.9rem;
      }
      th,
      td {
        font-size: 0.85rem;
      }
    }

    /* Instructions table dark mode */
    .instructions-table {
      font-size: 0.9rem;
      margin-top: 8px;
      width: 100%;
      border-collapse: collapse;
    }
    .instructions-table th,
    .instructions-table td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
    }
    .instructions-table .header-row {
      background: #e0e0e0;
    }
    .instructions-table .example-row {
      background: #f9f9f9;
    }
    .dark-mode .instructions-table th,
    .dark-mode .instructions-table td {
      border-color: #444;
      color: #ddd;
    }
    .dark-mode .instructions-table .header-row {
      background: #333;
    }
    .dark-mode .instructions-table .example-row {
      background: #222;
    }
  </style>
</head>
<body>
  <header>
    <h1>MTD Prototype</h1>
    <button id="darkModeToggle" class="dark-mode-toggle"><i class="fas fa-moon"></i></button>
  </header>
  <div class="tabs">
    <div class="tab active" onclick="showTab('profile')">Business Profile</div>
    <div class="tab" onclick="showTab('income')">Income</div>
    <div class="tab" onclick="showTab('expenses')">Expenses</div>
    <div class="tab" onclick="showTab('summary')">Summary</div>
  </div>
  <!-- Profile -->
  <section id="profile" class="section tab-content active">
    <h2>Business Profile</h2>
    <div id="profileDisplay">
      <p><strong>Business Name:</strong> <span id="displayName">Not set</span></p>
      <p><strong>VAT Number:</strong> <span id="displayVAT">Not set</span></p>
      <p><strong>VAT Rate:</strong> <span id="displayVATRate">20%</span></p>
      <p><strong>Business Type:</strong> <span id="displayType">Not set</span></p>
      <p><strong>Accounting Basis:</strong> <span id="displayBasis">Not set</span></p>
      <p><strong>Accounting Period:</strong> <span id="displayPeriod">Not set</span></p>
    </div>
    <form id="profileForm">
      <input type="text" id="businessName" placeholder="Business Name" required />
      <input type="text" id="vatNumber" placeholder="VAT Number" />
      <input type="number" id="vatRate" placeholder="VAT Rate %" min="0" max="100" step="0.01" value="20" />
      <select id="businessType">
        <option value="">Select Business Type</option>
        <option>Sole Trader</option>
        <option>Landlord</option>
        <option>Limited Company</option>
        <option>Partnership</option>
      </select>
      <select id="accountingBasis">
        <option value="">Select Accounting Basis</option>
        <option>Cash</option>
        <option>Accrual</option>
      </select>
      <input type="text" id="accountingPeriod" placeholder="Accounting Period (e.g. 2024–2025)" />
      <button type="submit">Update Profile</button>
    </form>
  </section>

  <!-- Income -->
  <section id="income" class="section tab-content">
    <h2>Record Income</h2>
    <form id="incomeForm">
      <input type="date" id="incomeDate" required />
      <input type="number" id="incomeAmount" placeholder="Gross Amount (£)" required />
      <select id="incomeCategory">
        <option>Consulting</option>
        <option>Sales</option>
        <option>Freelance</option>
        <option>Interest</option>
        <option>Other</option>
      </select>
      <input type="text" id="incomeDescription" placeholder="Description" />
      <label class="checkbox-label">Includes VAT?<input type="checkbox" id="incomeVAT" /></label>
      <label class="checkbox-label">Sold to EU or NI?<input type="checkbox" id="incomeEU" /></label>
      <button type="submit">Add Income</button>
    </form>

    <hr class="upload">
    <h3>Upload Income CSV</h3>
    <p class="csv-instructions">
      Cells A to F should take values in the following format.<br>The first row of your spreadsheet will be reserved for headers and will not be counted for values.
    </p>
    <table class="instructions-table">
      <tr class="header-row">
        <th>A</th>
        <th>B</th>
        <th>C</th>
        <th>D</th>
        <th>E</th>
        <th>F</th>
      </tr>
      <tr>
        <td>Date (DD-MM-YYYY)</td>
        <td>Gross (£)</td>
        <td>Category</td>
        <td>Description</td>
        <td>VAT (Y/N)</td>
        <td>EU (Y/N)</td>
      </tr>
      <tr class="example-row">
        <td>04-11-2025</td>
        <td>150.50</td>
        <td>Consulting</td>
        <td>Client XYZ</td>
        <td>Y</td>
        <td>N</td>
      </tr>
    </table>
    <input type="file" id="incomeCSV" accept=".csv" />
    <button id="importIncomeCSV">Import Income CSV</button>

    <div id="incomeTableWrapper"></div>
  </section>

  <!-- Expenses -->
  <section id="expenses" class="section tab-content">
    <h2>Record Expense</h2>
    <form id="expenseForm">
      <input type="date" id="expenseDate" required />
      <input type="number" id="expenseAmount" placeholder="Gross Amount (£)" required />
      <select id="expenseCategory">
        <option>Travel</option>
        <option>Equipment</option>
        <option>Office Supplies</option>
        <option>Utilities</option>
        <option>Marketing</option>
        <option>Professional Fees</option>
        <option>Other</option>
      </select>
      <input type="text" id="expenseDescription" placeholder="Description" />
      <label class="checkbox-label">Includes VAT?<input type="checkbox" id="expenseVAT" /></label>
      <label class="checkbox-label">Purchased from EU or NI?<input type="checkbox" id="expenseEU" /></label>
      <button type="submit">Add Expense</button>
    </form>

    <hr class="upload">
    <h3>Upload Expenses CSV</h3>
    <p class="csv-instructions">
      Cells A to F should take values in the following format.<br>The first row of your spreadsheet will be reserved for headers and will not be counted for values.
    </p>
    <table class="instructions-table">
      <tr class="header-row">
        <th>A</th>
        <th>B</th>
        <th>C</th>
        <th>D</th>
        <th>E</th>
        <th>F</th>
      </tr>
      <tr>
        <td>Date (DD-MM-YYYY)</td>
        <td>Gross (£)</td>
        <td>Category</td>
        <td>Description</td>
        <td>VAT (Y/N)</td>
        <td>EU (Y/N)</td>
      </tr>
      <tr class="example-row">
        <td>04-11-2025</td>
        <td>75.00</td>
        <td>Travel</td>
        <td>Taxi fare</td>
        <td>Y</td>
        <td>N</td>
      </tr>
    </table>
    <input type="file" id="expenseCSV" accept=".csv" />
    <button id="importExpenseCSV">Import Expenses CSV</button>

    <div id="expenseTableWrapper"></div>
  </section>

  <!-- Summary -->
  <section id="summary" class="section tab-content">
    <h2>Summary</h2>
    <label>Select Quarter:
      <select id="quarterSelect">
        <option value="1">Q1 (6 Apr – 5 Jul)</option>
        <option value="2">Q2 (6 Jul – 5 Oct)</option>
        <option value="3">Q3 (6 Oct – 5 Jan)</option>
        <option value="4">Q4 (6 Jan – 5 Apr)</option>
      </select>
    </label>
    <div class="summary">
      Total Income: £<span id="totalIncome">0</span><br>
      Total Expenses: £<span id="totalExpenses">0</span><br>
      Net Total: £<span id="netTotal">0</span>
    </div>
  </section>
  <script>
    const incomeForm = document.getElementById('incomeForm');
    const expenseForm = document.getElementById('expenseForm');
    const incomeTableWrapper = document.getElementById('incomeTableWrapper');
    const expenseTableWrapper = document.getElementById('expenseTableWrapper');
    const totalIncomeEl = document.getElementById('totalIncome');
    const totalExpensesEl = document.getElementById('totalExpenses');
    const netTotalEl = document.getElementById('netTotal');
    const darkModeToggle = document.getElementById('darkModeToggle');
    const profileForm = document.getElementById('profileForm');
    const quarterSelect = document.getElementById('quarterSelect');
    let records = { income: [], expenses: [] };
    let vatRate = 20;

    function showTab(tabId) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(section => section.classList.remove('active'));
      document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
      document.getElementById(tabId).classList.add('active');
    }

    function addRecord(type, date, gross, hasVAT, category, desc, isEU) {
      const rate = vatRate / 100;
      const vat = hasVAT ? (gross - gross / (1 + rate)) : 0;
      const net = gross - vat;
      const record = { date, gross, net, vat, category, desc, eu: isEU };
      records[type].push(record);
      // Logging
      console.log(`[ADD RECORD] Type: ${type}`);
      console.log(`Date: ${date}`);
      console.log(`Gross: £${gross.toFixed(2)}`);
      console.log(`VAT applicable: ${hasVAT}`);
      console.log(`VAT rate: ${vatRate}%`);
      console.log(`VAT amount: £${vat.toFixed(2)}`);
      console.log(`Net amount: £${net.toFixed(2)}`);
      console.log(`Category: ${category}`);
      console.log(`Description: ${desc}`);
      console.log(`EU?: ${isEU}`);
      console.log(`Current ${type} records:`, records[type]);
    }

    function renderTable(type) {
      const wrapper = type === 'income' ? incomeTableWrapper : expenseTableWrapper;
      wrapper.innerHTML = ''; // Clear existing content

      if (records[type].length === 0) {
        return; // No table or headers if no records
      }

      const table = document.createElement('table');
      table.innerHTML = `
        <tr>
          <th>Date</th>
          <th>Net (£)</th>
          <th>VAT (£)</th>
          <th>Category</th>
          <th>Description</th>
          <th>EU?</th>
        </tr>
      `;

      records[type].forEach(r => {
        const row = table.insertRow();
        row.innerHTML = `
          <td>${formatDisplayDate(r.date)}</td>
          <td>£${r.net.toFixed(2)}</td>
          <td>£${r.vat.toFixed(2)}</td>
          <td>${r.category}</td>
          <td>${r.desc}</td>
          <td>${r.eu ? '✔' : ''}</td>
        `;
      });

      wrapper.appendChild(table);
    }

    function updateSummary() {
      const startYear = 2025;
      const cutoffDates = [
        new Date(`${startYear}-07-06`),
        new Date(`${startYear}-10-06`),
        new Date(`${startYear+1}-01-06`),
        new Date(`${startYear+1}-04-06`)
      ];
      const upTo = cutoffDates[parseInt(quarterSelect.value)-1];
      const totalIncome = records.income.filter(r => new Date(r.date) < upTo).reduce((sum,r)=>sum+r.net,0);
      const totalExpenses = records.expenses.filter(r => new Date(r.date) < upTo).reduce((sum,r)=>sum+r.net,0);
      totalIncomeEl.textContent = totalIncome.toFixed(2);
      totalExpensesEl.textContent = totalExpenses.toFixed(2);
      netTotalEl.textContent = (totalIncome - totalExpenses).toFixed(2);
    }

    incomeForm.addEventListener('submit', e=>{
      e.preventDefault();
      addRecord(
        'income',
        incomeDate.value,
        parseFloat(incomeAmount.value),
        incomeVAT.checked,
        incomeCategory.value,
        incomeDescription.value,
        incomeEU.checked
      );
      renderTable('income');
      updateSummary();
      incomeForm.reset();
    });

    expenseForm.addEventListener('submit', e=>{
      e.preventDefault();
      addRecord(
        'expenses',
        expenseDate.value,
        parseFloat(expenseAmount.value),
        expenseVAT.checked,
        expenseCategory.value,
        expenseDescription.value,
        expenseEU.checked
      );
      renderTable('expenses');
      updateSummary();
      expenseForm.reset();
    });

    profileForm.addEventListener('submit', e=>{
      e.preventDefault();
      document.getElementById('displayName').textContent = businessName.value || 'Not set';
      document.getElementById('displayVAT').textContent = vatNumber.value || 'Not set';
      vatRate = parseFloat(document.getElementById('vatRate').value) || 20;
      document.getElementById('displayVATRate').textContent = vatRate + '%';
      document.getElementById('displayType').textContent = businessType.value || 'Not set';
      document.getElementById('displayBasis').textContent = accountingBasis.value || 'Not set';
      document.getElementById('displayPeriod').textContent = accountingPeriod.value || 'Not set';
      profileForm.reset();
    });

    quarterSelect.addEventListener('change', updateSummary);

    const icon = darkModeToggle.querySelector('i');
    darkModeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
      icon.classList.toggle('fa-sun');
      icon.classList.toggle('fa-moon');
    });

    // --- DATE HELPERS ---
    function parseDate(str) {
      if (!str) return null;
      const parts = (''+str).split(/[-\/]/);   // handle - or /
      if (parts.length !== 3) return null;
      let day, month, year;
      if (parts[0].length === 4) {            // YYYY-MM-DD
        year = parts[0];
        month = parts[1];
        day = parts[2];
      } else {                                // DD-MM-YYYY
        day = parts[0];
        month = parts[1];
        year = parts[2];
      }
      month = month.padStart(2, '0');
      day = day.padStart(2, '0');
      return `${year}-${month}-${day}`;       // internal format YYYY-MM-DD
    }

    function formatDisplayDate(date) {
      const parts = date.split('-');          // YYYY-MM-DD → DD-MM-YYYY
      return `${parts[2]}-${parts[1]}-${parts[0]}`;
    }

    // --- CSV upload handling ---
    function parseCSV(content) {
      const rows = content.trim().split(/\r?\n/).slice(1); // skip header
      const data = [];
      for (const row of rows) {
        const cols = row.split(',').map(c => c.trim());
        if (cols.length < 6) continue;
        let [date, gross, category, desc, vat, eu] = cols;
        date = parseDate(date);
        if (!date) continue;
        const parsed = {
          date,
          gross: parseFloat(gross),
          category,
          desc,
          hasVAT: vat.toUpperCase() === 'Y',
          isEU: eu.toUpperCase() === 'Y'
        };
        data.push(parsed);
      }
      return data;
    }

    function handleUpload(fileInput, type) {
      const file = fileInput.files[0];
      if (!file) return alert("Please select a file first.");

      const ext = file.name.split('.').pop().toLowerCase();
      if (ext !== 'csv') return alert("Unsupported file type.");

      const reader = new FileReader();
      reader.onload = e => {
        const parsed = parseCSV(e.target.result);      // all rows after header
        if (!parsed.length) return alert("No rows found in CSV (or only a header).");

        let validCount   = 0;
        let ignoredCount = 0;

        parsed.forEach(r => {
          if (r.date && !isNaN(r.gross)) {
            addRecord(type, r.date, r.gross, r.hasVAT, r.category, r.desc, r.isEU);
            validCount++;
          } else {
            ignoredCount++;
          }
        });

        renderTable(type);
        updateSummary();

        // ---- Clear user message ----
        if (ignoredCount === 0) {
          alert(`${validCount} ${type} record(s) imported successfully.`);
        } else {
          alert(
            `${validCount} ${type} record(s) imported.\n` +
            `${ignoredCount} row(s) ignored (missing date or amount).`
          );
        }
      };
      reader.readAsText(file);
    }

    // Event listeners for import buttons
    document.getElementById('importIncomeCSV').addEventListener('click', () => {
      handleUpload(document.getElementById('incomeCSV'), 'income');
    });

    document.getElementById('importExpenseCSV').addEventListener('click', () => {
      handleUpload(document.getElementById('expenseCSV'), 'expenses');
    });

    // Initial render
    renderTable('income');
    renderTable('expenses');
  </script>
</body>
</html>